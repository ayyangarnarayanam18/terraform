pipeline {
    agent any

    environment {
        APP_SERVER = "44.203.206.98"        // Application node public IP
        APP_USER   = "devops"               // SSH user
        SSH_KEY    = credentials('app-ssh-key') // Jenkins credential ID
        GIT_REPO   = "https://github.com/Amruth-B/assemment-addressbook.git"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'master', url: "${GIT_REPO}"
            }
        }

        stage('Build with Maven') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('Setup Tomcat on Application Node') {
            steps {
                sh '''
                ssh -i $SSH_KEY -o StrictHostKeyChecking=no ${APP_USER}@${APP_SERVER} '
                    # Install Tomcat if not already present
                    if [ ! -d /opt/tomcat9 ]; then
                        sudo apt-get update -y
                        sudo apt-get install -y openjdk-11-jdk wget
                        wget https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.75/bin/apache-tomcat-9.0.75.tar.gz
                        sudo mkdir -p /opt/tomcat9
                        sudo tar xzvf apache-tomcat-9.0.75.tar.gz -C /opt/tomcat9 --strip-components=1
                    fi

                    # Give ownership to devops user
                    sudo chown -R devops:devops /opt/tomcat9
                    chmod +x /opt/tomcat9/bin/*.sh
                '
                '''
            }
        }

        stage('Deploy WAR to Tomcat') {
            steps {
                sh '''
                # Stop Tomcat if running (ignore errors)
                ssh -i $SSH_KEY -o StrictHostKeyChecking=no ${APP_USER}@${APP_SERVER} "/opt/tomcat9/bin/shutdown.sh || true"

                # Copy WAR file
                scp -i $SSH_KEY -o StrictHostKeyChecking=no target/*.war ${APP_USER}@${APP_SERVER}:/opt/tomcat9/webapps/addressbook.war

                # Start Tomcat
                ssh -i $SSH_KEY -o StrictHostKeyChecking=no ${APP_USER}@${APP_SERVER} "/opt/tomcat9/bin/startup.sh"
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Deployment successful! App is running at http://${APP_SERVER}:8080/addressbook"
        }
        failure {
            echo "❌ Deployment failed. Check logs."
        }
    }
}
